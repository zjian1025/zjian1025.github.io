---
title: 异步无刷新请求
date: 2021-11-11 08:42:03
tags: 交互
categories: 常用
---
## 概念  
通过浏览器提供的一个JS API, 向服务端发送一个请求，返回的数据被JS 接收，然后再用JS的操作，将数据渲染到DOM；
***
## 分类
    现代的浏览器支持多个具有HTTP的 API:
* XMLHttpRequest
    出现较早，浏览器支持最好，但是比较陈旧，一些新的js语言特性需要封装（如：Promise）
* Fetch
    比较新，对一些新的特性有天然的良好的支持（如:Promise CORS）,但是兼容不好，而且缺少事件支持  
    *这里解释下,跨源资源共享（CORS），是一种基于HTTP 头的机制，该机制通过允许服务器标示除了它自己以外的其它origin（域，协议和端口），这样浏览器可以访问加载这些资源。更通俗的来说，就是用来处理跨域请求的一系列的请求头（具体可查看MDN文档https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS）*
***
## Fetch的使用
它返回一个 promise，这个 promise 会在请求响应后被 resolve，并传回 Response 对象。
* 语法:    **Promise<Response> fetch(input[, init])**;
* input: 请求的url或者是一个Request对象
* init:可选参数
    1.	**method**: GET或者POST
    2.	**headers**: 请求的头信息
    3.	**body**: 请求的 body 信息
    4.	**mode**: 请求的模式，如 cors、 no-cors 或者 same-origin
    5.	**mode**: 请求的模式，如 cors、 no-cors 或者 same-origin
    6.	**cache**:  请求的 cache 模式, default、 no-store、 reload no-cache 、 force-cache 或者 only-if-cached
    7.	**redirect**: 可用的 redirect 模式: follow (自动重定向), error (如果产生重定向将自动终止并且抛出一个错误）, 或者 manual (手动处理重定向)

###### 使用示例
    var myImage = document.querySelector('img');
    var myHeaders = new Headers();
    myHeaders.append('Content-Type', 'image/jpeg');
    var myInit = { 
        method: 'GET',
        headers: myHeaders,
        mode: 'cors',
        cache: 'default' };
    var myRequest = new Request('flowers.jpg');
    fetch(myRequest,myInit).then(function(response) {
    ...
    });
*因为Fetch的缺点，所以本文就简略介绍，有兴趣的小伙伴们可以到MDN上查阅文档*
https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch

***
## XMLHttpRequest使用
在不影响用户使用，能够刷新网页局部内容，XMLHttpRequest(XHR)对象在AJAX编程中被大量使用
* **XMLHttpRequest()构造函数，用来创建XHR实例对象**
* **属性**
    - **onreadystatechange**: 当 readyState 属性发生变化时,调用的event handler
    - **readyState**:请求的状态码
    - **response**：整个响应实体
    - **responseText**：对请求的响应
    - **responseType**：定义响应类型
    - **responseURL**: 返回经过序列化（serialized）的响应 URL
    - **responseXML**：该请求的响应
    - **status**：请求的响应状态 200 400….
    - **statusText**：服务器返回的响应状态 "200 OK"
    - **timeout**：数字，表示该请求的最大请求时间（毫秒），若超出该时间，请求会自动终止。
    - **ontimeout**：当请求超时调用的 event handler
    - **upload**: 代表上传进度。
    - **withCredentials**: 一个布尔值，用来指定跨域 Access-Control 请求是否应当带有授权信息，如 cookie 或授权 header 头。
* **方法**
    - **abort()**：如果请求已被发出，则立刻中止请求。
    - **getAllResponseHeaders()**：所有用 CRLF 分隔的响应头
    - **getResponseHeader()**：指定响应头的字符串
    - **open()**：初始化一个请求
    - **overrideMimeType()**：覆写由服务器返回的 MIME 类型
    - **send()**：发送请求。
    - **setRequestHeader()**：设置 HTTP 请求头的值。必须在 open() 之后、send() 之前调用 setRequestHeader() 方法。
  
* **事件**
    - **onabort**:请求被停止时
    - **onerror**：请求报错时
    - **onload**：请求完成时
    - **onloadend**：请求结束时，不论成功或者失败
    - **onloadstart**：请求接收到响应数据
    - **onprogress**：当请求接收到更多的数据，周期性的触发(可用来处理上传)
    - **ontimeout**：请求超时
*   **使用示例** 
        //创建XMR对象
        const xhr = new XMLHttpRequest();
        //配置请求参数
        xhr.open("post",url,false);//false为同步 true为异步
        //
        xhr.responseType = "JSON"
        //设置请求头
        xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
        //如果我们提交的是表单数据 formdata
        let fd = new FormData();
        fd.append('name','1111');
        // 回调事件
        xhr.onload = function () {
            console.log(xhr.response)
            console.log(xhr.responseText)
            console.log(xhr.responseType)
            console.log(xhr.responseURL)
            console.log(xhr.status)
            console.log(xhr.statusText)
            console.log(xhr.response)
        }
        //发送请求
        xhr.send(fd);
        xhr.onloadstart = function(){
            console.log('服务端开始下载了')
        }
        // 上传文件
        xhr.upload.onloadstart = function(){
            console.log('开始上传了')
        }
        xhr.upload.onprogress = function(e){
            console.log('间隔触发 100ms左右触发一次')
            console.log(e.loaded)
            console.log(e.total)
        }
        xhr.upload.onload = function(){
            console.log('上传完成')
        }

***

**参考资料**
https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API
https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest

***
